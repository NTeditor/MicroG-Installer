
SKIPUNZIP=1
# Установка в /system/product если android 9 и выше, если android 8 и ниже в /system

if [ $API -ge 28 ]; then
	ui_print "$API"
	PROSYS="$MODPATH/system/product"
elif [ $API -lt 28 ]; then
	ui_print "$API"
	PROSYS="$MODPATH/system"
else
	ui_print "$API"
	abort "Unknown"
fi

if [ -f "/data/.install-in-system" ]; then
	ui_print "- Обнаружен файл .install-in-system"
	ui_print "- Установка в /system"
	PROSYS="$MODPATH/system"
elif [ -f "/data/.install-in-product" ]; then
	ui_print "- Обнаружен файл .install-in-product"
	ui_print "- Установка в /system/product"
	PROSYS="$MODPATH/system/product"
fi

# Распаковка в APK файлов

ui_print "- Распаковка APK"
mkdir $PROSYS/priv-app/MicroG
mkdir $PROSYS/priv-app/MicroGStore
mkdir $PROSYS/priv-app/MicroGProxy

unzip -d "$PROSYS/priv-app/MicroG" "$ZIPFILE" -j "MicroG.apk"
unzip -d "$PROSYS/priv-app/MicroGStore" "$ZIPFILE" -j "MicroGStore.apk"
unzip -d "$PROSYS/priv-app/MicroGServices" "$ZIPFILE" -j "MicroGProxy.apk"

# Распаковка default-permissions и permissions"

ui_print "- Распаковка default-permissions и permissions"
mkdir $PROSYS/etc/default-permissions
mkdir $PROSYS/etc/permissions

unzip -d "$PROSYS/etc/default-permissions/" "$ZIPFILE" -j "d-perm/*"
unzip -d "$PROSYS/etc/permissions" "$ZIPFILE" -j "perm/*"

# Распаковка sysconfig

ui_print "- Распаковка sysconfig"
mkdir $PROSYS/etc/sysconfig
unzip -d "$PROSYS/etc/sysconfig" "$FILEZIP" -j "microg.xml"

# Распаковка Maps v1 framework

ui_print "- Распаковка Maps v1"
mkdir $PROSYS/framework
unzip -d "$PROSYS/framework" "$ZIPFILE" -j "com.google.android.maps.jar"

# Распаковка service.sh

ui_print "- Распаковка service.sh"
unzip -d "$MODPATH" "$ZIPFILE" -j "service.sh"

# Установка разришений (Владелец root, Группа root, chmod 644)

ui_print "- Установка разрешений..."

set_perm $PROSYS/etc/default-permissions/microg-permissions.xml 0 0 0644
set_perm $PROSYS/etc/permissions/com.google.android.maps.xml 0 0 0644
set_perm $PROSYS/etc/permissions/privapp-permissions-microg.xml 0 0 0644
set_perm $PROSYS/etc/sysconfig/microg.xml 0 0 0644
set_perm $PROSYS/priv-app/MicroGProxy/MicroGServices.apk 0 0 0644
set_perm $PROSYS/priv-app/MicroGStore/microGStore.apk 0 0 0644
set_perm $PROSYS/priv-app/MicroG/microG.apk 0 0 0644
set_perm $PROSYS/framework/com.google.android.maps.jar 0 0 0644

# Установка разришений (Владелец root, Группа root, chmod 755)

set_perm $MODPATH/service.sh 0 0 0755

sed -i 's/PROSYS=".*"/PROSYS='$PROSYS'/1' "$MODPATH/service.sh"

